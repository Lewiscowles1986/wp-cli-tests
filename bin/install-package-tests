#!/bin/sh

# Database credentials can be provided via environment variables:
# - WP_CLI_TEST_DBHOST is the host to use and can include a port, i.e "127.0.0.1:33060" (defaults to "localhost")
# - WP_CLI_TEST_DBUSER is the user that has permission to administer databases and users (defaults to "root").
# - WP_CLI_TEST_DBPASS is the password to use for the above user (defaults to an empty password).

HOST=localhost
PORT=""
HOST_STRING=''
if [ ! -z "$WP_CLI_TEST_DBHOST" ]; then
	case ${WP_CLI_TEST_DBHOST##*[]]} in
		(*:*) HOST=${WP_CLI_TEST_DBHOST%:*} PORT=${WP_CLI_TEST_DBHOST##*:};;
		(*)   HOST=$WP_CLI_TEST_DBHOST;;
	esac
  HOST_STRING="-h$HOST"
  if [ ! -z "$PORT" ]; then
  	HOST_STRING="$HOST_STRING -P$PORT"
	fi
fi

USER=root
if [ ! -z "$WP_CLI_TEST_DBUSER" ]; then
  USER="$WP_CLI_TEST_DBUSER"
fi

PASSWORD_STRING=""
if [ ! -z "$WP_CLI_TEST_DBPASS" ]; then
  PASSWORD_STRING="-p$WP_CLI_TEST_DBPASS"
fi

set -ex

# Prepare the database for running the tests.
install_db() {
	mysql -e "CREATE DATABASE IF NOT EXISTS wp_cli_test;" $HOST_STRING -u"$USER" "$PASSWORD_STRING"
	mysql -e "GRANT ALL ON wp_cli_test.* TO 'wp_cli_test@$HOST' IDENTIFIED BY 'password1'"" $HOST_STRING -u"$USER" "$PASSWORD_STRING"
	mysql -e "GRANT ALL ON wp_cli_test_scaffold.* TO 'wp_cli_test@$HOST' IDENTIFIED BY 'password1'"" $HOST_STRING -u"$USER" "$PASSWORD_STRING"
}

install_db
